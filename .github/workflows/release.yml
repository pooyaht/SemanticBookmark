name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.1.0, v1.2.3

permissions:
  contents: write  # Required for creating releases

jobs:
  # Job 1: Run tests before release
  test:
    name: Pre-release Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm run lint

      - name: Run tests
        run: pnpm test
        env:
          CI: true

  # Job 2: Build and Release
  release:
    name: Build and Create Release
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Build Chrome
      - name: Build Chrome extension
        run: pnpm run build:chrome
        env:
          NODE_ENV: production

      - name: Package Chrome extension
        run: |
          cd dist/chrome
          zip -r ../../semantic-bookmark-chrome-${{ github.ref_name }}.zip .
          cd ../..

      # Build Firefox
      - name: Build Firefox extension
        run: pnpm run build:firefox
        env:
          NODE_ENV: production

      - name: Package Firefox extension
        run: |
          cd dist/firefox
          zip -r ../../semantic-bookmark-firefox-${{ github.ref_name }}.zip .
          cd ../..

      # Calculate checksums
      - name: Generate checksums
        run: |
          sha256sum semantic-bookmark-chrome-${{ github.ref_name }}.zip > checksums.txt
          sha256sum semantic-bookmark-firefox-${{ github.ref_name }}.zip >> checksums.txt
          cat checksums.txt

      # Extract version from tag
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # Generate release notes
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Semantic Bookmark Search Extension ${{ github.ref_name }}

          ### ðŸ“¦ Downloads

          Download the extension for your browser:

          - **Chrome**: `semantic-bookmark-chrome-${{ github.ref_name }}.zip`
          - **Firefox**: `semantic-bookmark-firefox-${{ github.ref_name }}.zip`

          ### ðŸš€ Installation

          #### Chrome
          1. Download `semantic-bookmark-chrome-${{ github.ref_name }}.zip`
          2. Extract the zip file
          3. Go to `chrome://extensions`
          4. Enable "Developer mode"
          5. Click "Load unpacked"
          6. Select the extracted folder

          #### Firefox
          1. Download `semantic-bookmark-firefox-${{ github.ref_name }}.zip`
          2. Extract the zip file
          3. Go to `about:debugging#/runtime/this-firefox`
          4. Click "Load Temporary Add-on"
          5. Select any file in the extracted folder

          ### ðŸ” Checksums

          SHA256 checksums for verification:
          ```
          $(cat checksums.txt)
          ```

          ### ðŸ“ Changes

          See [CHANGELOG.md](CHANGELOG.md) for detailed changes in this release.

          ---

          **Note**: For production use in Chrome Web Store or Firefox Add-ons, the signed versions will be available after review.
          EOF

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          files: |
            semantic-bookmark-chrome-${{ github.ref_name }}.zip
            semantic-bookmark-firefox-${{ github.ref_name }}.zip
            checksums.txt
          fail_on_unmatched_files: true

      # Upload artifacts (for backup)
      - name: Upload Chrome artifact
        uses: actions/upload-artifact@v5
        with:
          name: semantic-bookmark-chrome-${{ github.ref_name }}
          path: semantic-bookmark-chrome-${{ github.ref_name }}.zip
          retention-days: 90

      - name: Upload Firefox artifact
        uses: actions/upload-artifact@v5
        with:
          name: semantic-bookmark-firefox-${{ github.ref_name }}
          path: semantic-bookmark-firefox-${{ github.ref_name }}.zip
          retention-days: 90

  # Job 3: Publish to Chrome Web Store (optional, for future)
  publish-chrome:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    needs: release
    if: false  # Disabled by default - enable when ready
    # if: ${{ !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      # This would use chrome-webstore-upload-cli or similar
      - name: Publish to Chrome Web Store
        run: echo "Chrome Web Store publishing not yet configured"
        # env:
        #   CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
        #   CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
        #   CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}

  # Job 4: Publish to Firefox Add-ons (optional, for future)
  publish-firefox:
    name: Publish to Firefox Add-ons
    runs-on: ubuntu-latest
    needs: release
    if: false  # Disabled by default - enable when ready
    # if: ${{ !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      # This would use web-ext or similar
      - name: Publish to Firefox Add-ons
        run: echo "Firefox Add-ons publishing not yet configured"
        # env:
        #   WEB_EXT_API_KEY: ${{ secrets.WEB_EXT_API_KEY }}
        #   WEB_EXT_API_SECRET: ${{ secrets.WEB_EXT_API_SECRET }}
